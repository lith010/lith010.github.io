'use strict';define("xwiki-attachments-store",["jquery"],function(k){var n=function(f,l){var c=[XWiki.contextPath,"rest"];f.getReversedReferenceChain().forEach(function(g){var m=g.type===XWiki.EntityType.DOCUMENT?"page":XWiki.EntityType.getName(g.type);c.push(m+"s",encodeURIComponent(g.name))});f.type===XWiki.EntityType.ATTACHMENT?c.push("metadata"):c.push("attachments");f=k.param(k.extend({prettyNames:!0},l),!0);return c.join("/")+"?"+f};return{get:function(f,l){return k.getJSON(n(f),l)},upload:function(f,
l){var c=new FormData;c.append("file",l);c.append("filename",f.name);var g=k.Deferred();k.post({url:n(f.parent,{createPage:!0}),data:c,processData:!1,contentType:!1,dataType:"json",xhr:function(){var m=k.ajaxSettings.xhr();m.upload&&m.upload.addEventListener("progress",function(p){p.lengthComputable&&g.notify({loaded:p.loaded,total:p.total,percent:Math.round(100*p.loaded/p.total)})},!1);return m}}).then(g.resolve.bind(g),g.reject.bind(g));return g.promise()},create:function(f,l){var c=(new XWiki.Document(f.parent)).getURL("download")+
"/"+encodeURIComponent(f.name),g=f.getReversedReferenceChain().map(function(m){return{type:XWiki.EntityType.getName(m.type),name:m.name,label:m.name}});f={id:XWiki.Model.serialize(f),name:f.name,xwikiRelativeUrl:c,hierarchy:{items:g}};l&&k.extend(f,{mimeType:l.type,file:l});return f}}});
define("xwiki-attachments-filter",["jquery"],function(k){return{filter:function(n,f){var l=[];"string"===typeof f&&(l=f.split(/\s*,\s*/).filter(function(c){return 0<c.length}));return n.filter(function(c){a:{for(var g=l,m=0;m<g.length;m++){var p=g[m];if("."===p.substring(0,1)){if(c.name.substring(c.name.length-p.length)===p){c=!0;break a}}else if("string"===typeof c.mimeType&&0<=c.mimeType.indexOf(p)){c=!0;break a}}c=0===g.length}return c})}}});
define("xwiki-file-picker",["jquery"],function(k){var n=function(f,l){var c;k(window).one("focus.filePicker",function(m){c=setTimeout(function(){l.reject()},1E3)});var g=k('<input type="file" class="hidden"/>').prop("multiple",!!f.multiple).appendTo("body");"string"===typeof f.accept&&g.attr("accept",f.accept.replace(/\/(\s*(,|$))/g,"/*$1"));g.on("change",function(m){k(window).off("focus.filePicker");clearTimeout(c);l.resolve(this.files);g.remove()}).click()};return{pickLocalFiles:function(f){return new Promise((l,
c)=>n(f,{resolve:l,reject:c}))}}});define("xwiki-suggestAttachments-messages",{prefix:"web.uicomponents.suggest.attachments.",keys:["upload","uploading","uploadDone","uploadFailed"]});
define("xwiki-suggestAttachments","jquery xwiki-attachments-store xwiki-attachments-icon xwiki-attachments-filter xwiki-file-picker xwiki-l10n!xwiki-suggestAttachments-messages xwiki-selectize".split(" "),function(k,n,f,l,c,g){var m=function(b){return{maxOptions:10,documentReference:b.data("documentReference"),searchScope:b.data("searchScope"),useAttachmentName:!1,uploadAllowed:"true"===b.data("uploadAllowed")||!0===b.data("uploadAllowed"),accept:b.data("accept"),load:function(a,h){var d=this.settings,
e=d.searchScope;""!==a||e&&!d.documentReference.hasParent(e)||(e=d.documentReference);n.get(e,{name:a,types:d.accept,number:d.maxOptions}).then(r.bind(null,d)).then(h,h)},loadSelected:function(a,h){p(a,this.settings).then(h,h)},create:function(a,h){if(0<a.length)return h={},h[this.settings.labelField]=a,h[this.settings.valueField]=a,h;c.pickLocalFiles({accept:this.settings.accept,multiple:1!==this.settings.maxItems}).then(u.bind(null,this)).then(h,h)}}},p=function(b,a){b=v(b,a);return n.get(b).then(t.bind(null,
a)).then(function(h){return[h]})},r=function(b,a){return Array.isArray(a.attachments)?a.attachments.map(t.bind(null,b)):[]},t=function(b,a){var h=XWiki.Model.resolve(a.id,XWiki.EntityType.ATTACHMENT),d=a.name;b=b.useAttachmentName&&b.searchScope&&b.searchScope.type===XWiki.EntityType.DOCUMENT?h.name:h.parent.equals(b.documentReference)?XWiki.Model.serialize(h.relativeTo(b.documentReference)):XWiki.Model.serialize(h.relativeTo(b.documentReference.getRoot()));return{label:d,value:b,url:a.xwikiRelativeUrl,
icon:f.getIcon(a),hint:w(a),data:a}},v=function(b,a){return a.useAttachmentName&&a.searchScope&&a.searchScope.type===XWiki.EntityType.DOCUMENT?new XWiki.AttachmentReference(b,a.searchScope):XWiki.Model.resolve(b,XWiki.EntityType.ATTACHMENT,a.documentReference)},w=function(b){return b.hierarchy.items.filter(function(a){return"space"===a.type||"document"===a.type&&"WebHome"!==a.name}).map(function(a){return a.label}).join(" / ")},y=function(b){b.get$("wrapper").addClass("async-create");var a=b.canCreate;
b.canCreate=function(e){return 0===e.length||a.apply(this,arguments)};var h=b.settings.render.option_create;b.settings.render.option_create=function(e,q){return 0<e.input.length?h.apply(this,arguments):k('<div class="create upload option"></div>').text(g.upload)};var d=b.settings.render.item;b.settings.render.item=function(e){var q=d.apply(this,arguments);e.data&&e.data.upload&&(q.addClass("upload create-"+e.data.upload.status),"running"===e.data.upload.status&&q.css("background","linear-gradient(90deg, #dff0d8 "+
e.data.upload.progress.percent+"%, #efefef 0)"));return q};x(b)},u=function(b,a){a=z(a,b.settings);a=l.filter(a,b.settings.accept);1===b.settings.maxItems&&(a=a.slice(0,1));a=r(b.settings,{attachments:a});b.addOption(a);a.reduce((h,d)=>{b.addItem(d.value);d.icon.promise&&d.icon.promise.then(function(){b.updateOption(d.value,d)});var e=A.bind(null,d,b);return h.then(e,e)},Promise.resolve());return a},z=function(b,a){for(var h=[],d=0;d<b.length;d++){var e=b.item(d),q=new XWiki.EntityReference(e.name,
XWiki.EntityType.ATTACHMENT,a.documentReference);h.push(n.create(q,e))}return h},A=function(b,a){var h=k("<em></em>").text(b.label).prop("outerHTML"),d=new XWiki.widgets.Notification(g.get("uploading",h),"inprogress");b.data.upload={status:"pending",progress:{loaded:0,total:b.data.file.size,percent:0}};return B(b.data).then(t.bind(null,a.settings)).then(f.loadIcon).progress(e=>{b.data.upload.status="running";b.data.upload.progress=e;a.updateOption(b.value,b)}).then(e=>{e.data.upload={status:"done"};
a.updateOption(e.value,e);d.replace(new XWiki.widgets.Notification(g.get("uploadDone",h),"done"));return e}).catch(()=>{b.data.upload.status="failed";a.updateOption(b.value,b);d.replace(new XWiki.widgets.Notification(g.get("uploadFailed",h),"error"));return Promise.reject()})},B=function(b){var a=XWiki.Model.resolve(b.id,XWiki.EntityType.ATTACHMENT);return n.upload(a,b.file)},x=function(b){b.get$("wrapper").on("drag dragstart dragend dragover dragenter dragleave drop",function(a){a.preventDefault();
a.stopPropagation()}).on("dragover dragenter",function(){k(this).addClass("is-dragover")}).on("dragleave dragend drop",function(){k(this).removeClass("is-dragover")}).on("drop",function(a){a=a.originalEvent.dataTransfer;0<a.files.length?u(b,a.files):C(b,a.getData("text/html"))})},C=function(b,a){k(a).find('[data-entity-type="ATTACHMENT"][data-entity-reference]').each(function(){var h=XWiki.Model.resolve(k(this).data("entityReference"),XWiki.EntityType.ATTACHMENT);n.get(h).then(d=>{d=r(b.settings,
{attachments:l.filter([d],b.settings.accept)});b.addOption(d);d.forEach(function(e){b.addItem(e.value)})})})},D=function(b){var a=b.settings.render.option;b.settings.render.option=function(h){var d=a.apply(this,arguments),e=d.find(".xwiki-selectize-option-hint");b.settings.searchScope.type===XWiki.EntityType.DOCUMENT?e.remove():1===e.length&&(k('<div class="xwiki-selectize-option-label-wrapper"></div>').append(d.find(".xwiki-selectize-option-label")).append(e).appendTo(d),d.find(".xwiki-selectize-option-icon-wrapper").addClass("pull-left"));
return d}};k.fn.suggestAttachments=function(b){return this.each(function(){var a=k.extend(m(k(this)),b),h=k(this),d=h.xwikiSelectize;a.documentReference&&"string"!==typeof a.documentReference||(a.documentReference=XWiki.Model.resolve(a.documentReference,XWiki.EntityType.DOCUMENT,XWiki.currentDocument.documentReference));a:{var e=a.searchScope||"wiki:"+XWiki.currentWiki;if("string"===typeof e)try{var q=XWiki.Model.resolve(e,null,XWiki.currentDocument.documentReference);break a}catch(E){q=null;break a}q=
e}a.searchScope=q;d.call(h,a);this.selectize.settings.uploadAllowed&&y(this.selectize);D(this.selectize)})}});
define("xwiki-attachmentResourcePicker",["jquery","xwiki-suggestAttachments"],function(k){var n=function(){f(this.selectize);var l=this.selectize.settings.loadSelected;this.selectize.settings.loadSelected=function(c,g){var m=this.options[c];m&&m.data?g(c):l.apply(this,arguments)}},f=function(l){Object.keys(l.options).forEach(function(c){var g=l.options[c];a:{var m=l.settings.supportedResourceTypes;var p=c.indexOf(":");if(0<=p){var r=c.substring(0,p).toLowerCase();if(0<=m.indexOf(r)){m={type:r,reference:c.substring(p+
1)};break a}}m={type:"attach",reference:c}}"attach"===m.type?c!==m.reference&&(g[l.settings.valueField]=m.reference,l.updateOption(c,g)):g.data||(g.data.resourceReference=m)})};k.fn.pickAttachmentResource=function(l){return this.on("initialize",n).each(function(){var c=k.extend({supportedResourceTypes:k(this).data("supportedResourceTypes")||"attach, data, url, path, unc"},l);"string"===typeof c.supportedResourceTypes&&(c.supportedResourceTypes=c.supportedResourceTypes.split(/\s*,\s*/).filter(function(g){return 0<
g.length}).map(function(g){return g.toLowerCase()}));k(this).suggestAttachments(c)})}});require(["jquery","xwiki-suggestAttachments","xwiki-attachmentResourcePicker","xwiki-events-bridge"],function(k){var n=function(f,l){f=k(l&&l.elements||document);f.find(".suggest-attachments").suggestAttachments();f.find(".pick-attachment-resource").pickAttachmentResource()};k(document).on("xwiki:dom:updated",n);k(n)});
//# sourceMappingURL=suggestAttachments.min.js.map
